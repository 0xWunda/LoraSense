<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>LoraSense Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        h1 { color: #2c3e50; text-align: center; }
        .cards { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .card {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            flex: 1 1 200px;
            max-width: 200px;
            text-align: center;
        }
        .card h2 { font-size: 1.5em; margin-bottom: 10px; color: #333; }
        .card p { font-size: 2em; margin: 0; color: #007bff; }
        .chart-container { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #ddd; }
        th { background: #007bff; color: #fff; }
        tbody tr:hover { background: #f1f1f1; }
    </style>
</head>
<body>
    <h1>LoraSense Dashboard</h1>

    <div class="cards">
        <div class="card">
            <h2>Temperatur</h2>
            <p id="temp">-- °C</p>
        </div>
        <div class="card">
            <h2>Luftfeuchtigkeit</h2>
            <p id="humidity">-- %</p>
        </div>
        <div class="card">
            <h2>Druck</h2>
            <p id="pressure">-- hPa</p>
        </div>
        <div class="card">
            <h2>Batterie</h2>
            <p id="battery">-- V</p>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="tempChart" height="150"></canvas>
    </div>

    <div>
        <h2>Historie der letzten Messwerte</h2>
        <table id="history-table">
            <thead>
                <tr>
                    <th>Zeit</th>
                    <th>Temperatur °C</th>
                    <th>Feuchtigkeit %</th>
                    <th>Druck hPa</th>
                    <th>Batterie V</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const tempEl = document.getElementById("temp");
        const humidityEl = document.getElementById("humidity");
        const pressureEl = document.getElementById("pressure");
        const batteryEl = document.getElementById("battery");
        const tableBody = document.querySelector("#history-table tbody");
        const ctx = document.getElementById("tempChart").getContext("2d");
        let tempChart;

        async function loadData() {
            try {
                const res = await fetch('/api/data');
                const data = await res.json();
                if(!data || data.length === 0) return;

                // Aktuelle Werte
                const latest = data[data.length - 1].decoded;
                tempEl.textContent = latest.Temperature ?? "--";
                humidityEl.textContent = latest.Humidity ?? "--";
                pressureEl.textContent = latest.Pressure ?? "--";
                batteryEl.textContent = latest.Battery ?? "--";

                // Tabelle Historie
                tableBody.innerHTML = "";
                const timestamps = [];
                const temperatures = [];
                const humidities = [];

                data.forEach(item => {
                    const d = item.decoded;
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${item.timestamp.split("T")[1].slice(0,8)}</td>
                        <td>${d.Temperature ?? "-"}</td>
                        <td>${d.Humidity ?? "-"}</td>
                        <td>${d.Pressure ?? "-"}</td>
                        <td>${d.Battery ?? "-"}</td>
                    `;
                    tableBody.appendChild(row);

                    timestamps.push(item.timestamp.split("T")[1].slice(0,8));
                    temperatures.push(d.Temperature ?? null);
                    humidities.push(d.Humidity ?? null);
                });

                // Chart aktualisieren
                if(tempChart) tempChart.destroy();
                tempChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timestamps,
                        datasets: [
                            {
                                label: 'Temperatur °C',
                                data: temperatures,
                                borderColor: 'rgb(255,99,132)',
                                fill: false,
                                tension: 0.3
                            },
                            {
                                label: 'Luftfeuchtigkeit %',
                                data: humidities,
                                borderColor: 'rgb(54,162,235)',
                                fill: false,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: false } }
                    }
                });

            } catch (err) {
                console.error("Fehler beim Laden der Daten:", err);
            }
        }

        loadData();
        setInterval(loadData, 3 * 60 * 1000); // alle 3 Minuten
    </script>
</body>
</html>

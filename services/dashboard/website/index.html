<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoraSense Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        .glass-sidebar {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 174, 239, 0.15);
            border-color: rgba(0, 174, 239, 0.3);
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        [v-cloak] {
            display: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="overflow-hidden">
    <div id="app" v-cloak class="flex h-screen selection:bg-[#00AEEF]/30">

        <!-- LOGIN OVERLAY -->
        {% include 'partials/login.html' %}

        <!-- SIDEBAR -->
        <aside v-if="isLoggedIn"
            class="w-20 lg:w-64 glass-sidebar flex flex-col justify-between py-8 transition-all duration-300 z-20">
            <div class="px-4 lg:px-8">
                <div class="flex items-center gap-4 mb-12">
                    <div
                        class="w-12 h-12 bg-white/5 rounded-xl flex items-center justify-center shadow-lg shadow-sky-500/20 shrink-0 p-2">
                        <img src="{{ url_for('static', filename='images/LoRaSense_Logo.png') }}" alt="LoRaSense Logo"
                            class="w-full h-full object-contain">
                    </div>
                    <span class="text-xl font-bold tracking-tight hidden lg:block">Lora<span
                            class="text-[#00AEEF]">Sense</span></span>
                </div>

                <nav class="space-y-2">
                    <a @click="currentView = 'dashboard'"
                        :class="{'bg-[#005696]/20 text-[#00AEEF] shadow-lg shadow-[#00AEEF]/5': currentView === 'dashboard', 'text-gray-400 hover:text-[#00AEEF] hover:bg-[#00AEEF]/5': currentView !== 'dashboard'}"
                        class="flex items-center gap-4 px-4 py-3 rounded-2xl cursor-pointer transition-all duration-200 group">
                        <i data-lucide="layout-grid" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-medium hidden lg:block">Dashboard</span>
                    </a>
                    <a @click="currentView = 'history'"
                        :class="{'bg-[#005696]/20 text-[#00AEEF] shadow-lg shadow-[#00AEEF]/5': currentView === 'history', 'text-gray-400 hover:text-[#00AEEF] hover:bg-[#00AEEF]/5': currentView !== 'history'}"
                        class="flex items-center gap-4 px-4 py-3 rounded-2xl cursor-pointer transition-all duration-200 group">
                        <i data-lucide="history" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-medium hidden lg:block">Historie</span>
                    </a>
                    <a v-if="isAdmin" @click="fetchUsers(); currentView = 'admin'"
                        :class="{'bg-[#005696]/20 text-[#00AEEF] shadow-lg shadow-[#00AEEF]/5': currentView === 'admin', 'text-gray-400 hover:text-[#00AEEF] hover:bg-[#00AEEF]/5': currentView !== 'admin'}"
                        class="flex items-center gap-4 px-4 py-3 rounded-2xl cursor-pointer transition-all duration-200 group">
                        <i data-lucide="users" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="font-medium hidden lg:block">Verwaltung</span>
                    </a>
                </nav>
            </div>

            <div class="px-4 lg:px-8">
                <div class="p-4 glass rounded-2xl mb-4 hidden lg:block">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="w-2 h-2 rounded-full animate-pulse"
                            :class="isConnected ? 'bg-[#00AEEF]' : 'bg-red-400'"></div>
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-400">System Status</span>
                    </div>
                    <div class="text-sm font-medium text-gray-200">[[ isConnected ? 'Online' : 'Offline' ]]</div>
                    <div class="text-xs text-gray-500 mt-1">Updates live</div>
                </div>
                <button @click="logout"
                    class="flex items-center gap-4 px-4 py-3 text-gray-400 hover:text-red-400 hover:bg-red-400/10 rounded-2xl transition-all w-full">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium hidden lg:block">Abmelden</span>
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main v-if="isLoggedIn" class="flex-1 overflow-y-auto relative z-10 p-4 lg:p-10">
            <!-- Header -->
            <header class="flex justify-between items-center mb-10">
                <div>
                    <h2
                        class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                        [[ viewTitle ]]</h2>
                    <p class="text-gray-400 mt-1">[[ viewSubtitle ]]</p>
                </div>
                <div class="flex items-center gap-4">
                    <button v-if="currentView === 'history'" @click="exportSelectedSensors"
                        class="glass px-6 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-indigo-600 transition-all active:scale-95 shadow-lg shadow-indigo-600/10">
                        <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                    </button>
                    <div class="glass px-4 py-2 rounded-xl flex items-center gap-3">
                        <div
                            class="w-8 h-8 rounded-full bg-gradient-to-br from-[#005696] to-[#00AEEF] flex items-center justify-center text-xs font-bold">
                            [[ username.charAt(0).toUpperCase() ]]
                        </div>
                        <span class="text-sm font-medium hidden sm:block">[[ username ]]</span>
                    </div>
                </div>
            </header>

            <!-- VIEWS -->
            <transition name="fade" mode="out-in">
                <div key="content">

                    <!-- Dashboard Grid -->
                    {% include 'partials/dashboard.html' %}

                    <!-- Detail View -->
                    {% include 'partials/detail.html' %}

                    <!-- History View -->
                    {% include 'partials/history.html' %}

                    <!-- Admin View -->
                    {% include 'partials/admin.html' %}

                </div>
            </transition>
        </main>
    </div>

    <!-- VUE APP LOGIC -->
    <script>
        const { createApp, ref, onMounted, computed, watch, nextTick, reactive } = Vue;
        const app = createApp({
            delimiters: ['[[', ']]'],
            setup() {
                // STATE
                const isLoggedIn = ref({{ 'true' if not show_login else 'false' }});
        const username = ref('User');
        const isAdmin = ref(false);
        const currentView = ref('dashboard'); // dashboard, detail, history, admin
        const sensors = ref([]);
        const selectedSensor = ref(null);
        const sensorData = ref([]);
        const isConnected = ref(true);
        const loginForm = ref({ username: '', password: '' });
        const loginError = ref('');
        const selectedSensorIds = ref([]); // For CSV export station selection

        // Admin State
        const userList = ref([]);
        const showAdminModal = ref(false);
        const showCreateUserModal = ref(false);
        const createUserForm = reactive({ username: '', password: '', is_admin: false });
        const selectedUser = ref(null);
        const tempPermissions = ref([]);
        const allAvailableSensors = ref([]);

        let charts = {};
        let updateTimer = null;

        // COMPUTED
        const allData = ref([]); // For history view

        const viewTitle = computed(() => {
            if (currentView.value === 'dashboard') return 'Übersicht';
            if (currentView.value === 'detail') return selectedSensor.value ? selectedSensor.value : 'Details';
            if (currentView.value === 'history') return 'Historie';
            if (currentView.value === 'admin') return 'Verwaltung';
            return '';
        });

        const viewSubtitle = computed(() => {
            if (currentView.value === 'dashboard') return 'Echtzeit-Daten aller Sensoren';
            if (currentView.value === 'detail') return 'Detaillierte Analyse & Graphen';
            if (currentView.value === 'history') return 'Langzeitarchiv & Export';
            if (currentView.value === 'admin') return 'Benutzerzugriffe steuern';
            return '';
        });

        // METHODS
        const login = async () => {
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginForm.value)
                });
                const data = await res.json();
                if (data.success) {
                    checkStatus();
                    // Force refresh sensors
                    fetchSensors();
                } else {
                    loginError.value = data.message || 'Login fehlgeschlagen';
                }
            } catch (e) {
                loginError.value = 'Serverfehler';
            }
        };

        const logout = async () => {
            await fetch('/api/logout');
            isLoggedIn.value = false;
            currentView.value = 'dashboard';
            selectedSensor.value = null;
        };

        const checkStatus = async () => {
            const res = await fetch('/api/status');
            const data = await res.json();
            isLoggedIn.value = data.logged_in;
            if (data.logged_in) {
                username.value = data.username;
                isAdmin.value = data.is_admin;
                fetchSensors();
            }
        };

        const fetchSensors = async () => {
            if (!isLoggedIn.value) return;
            try {
                const res = await fetch('/api/sensors');
                if (res.ok) {
                    sensors.value = await res.json();
                    // Fetch history for all sensors for the table
                    const promises = sensors.value.map(s => fetch('/api/data/' + s.id).then(r => r.json()));
                    const results = await Promise.all(promises);
                    allData.value = results.flat().sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Collect unique sensor IDs for admin selection (from history + current)
                    const ids = new Set(sensors.value.map(s => s.id));
                    // Also add mock sensors if not present (hack for demo)
                    ["LoraSense-Alpha-01", "LoraSense-Beta-02", "LoraSense-Gamma-03", "LoraSense-Delta-04"].forEach(id => ids.add(id));
                    allAvailableSensors.value = Array.from(ids).sort();
                }
            } catch (e) {
                console.error("Error fetching sensors", e);
                isConnected.value = false;
            }
        };

        const fetchUsers = async () => {
            console.log("Fetching users...");
            if (!isAdmin.value) {
                console.warn("fetchUsers called but not admin");
                return;
            }
            try {
                const res = await fetch('/api/admin/users');
                if (!res.ok) {
                    console.error("fetchUsers failed", res.status);
                    return;
                }
                const data = await res.json();
                console.log("Users fetched:", data);
                if (Array.isArray(data)) {
                    userList.value = data;
                } else {
                    console.error("Data is not array:", data);
                }
            } catch (e) {
                console.error("fetchUsers error:", e);
            }
        };

        const openCreateUserModal = () => {
            createUserForm.username = '';
            createUserForm.password = '';
            createUserForm.is_admin = false;
            showCreateUserModal.value = true;
        };

        const closeCreateUserModal = () => {
            showCreateUserModal.value = false;
        };

        const createUser = async () => {
            if (!createUserForm.username || !createUserForm.password) return;
            try {
                const res = await fetch('/api/admin/users/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createUserForm)
                });

                if (!res.ok) {
                    // Try to parse error message if possible
                    try {
                        const data = await res.json();
                        alert('Fehler: ' + (data.message || 'Serverfehler (' + res.status + ')'));
                    } catch (e) {
                        // If not JSON, it might be a 404 HTML page if the server code isn't updated
                        if (res.status === 404) {
                            alert('Fehler (404): API nicht gefunden. Bitte Server neu starten!');
                        } else {
                            alert('Server Fehler (' + res.status + ')');
                        }
                    }
                    return;
                }

                const data = await res.json();
                if (data.success) {
                    closeCreateUserModal();
                    fetchUsers(); // Refresh list
                } else {
                    alert('Fehler: ' + (data.message || 'Konnte Benutzer nicht erstellen'));
                }
            } catch (e) {
                console.error(e);
                alert('Netzwerkfehler: ' + e.message);
            }
        };

        const openPermissionsModal = async (user) => {
            selectedUser.value = user;
            // Fetch permissions
            const res = await fetch(`/api/admin/users/${user.id}/sensors`);
            const sensors = await res.json();
            tempPermissions.value = sensors;
            showAdminModal.value = true;
        };

        const closeAdminModal = () => {
            showAdminModal.value = false;
            selectedUser.value = null;
            tempPermissions.value = [];
        };

        const toggleSensorPermission = (sensorId) => {
            const index = tempPermissions.value.indexOf(sensorId);
            if (index === -1) {
                tempPermissions.value.push(sensorId);
            } else {
                tempPermissions.value.splice(index, 1);
            }
        };

        const savePermissions = async () => {
            if (!selectedUser.value) return;
            await fetch(`/api/admin/users/${selectedUser.value.id}/sensors`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sensors: tempPermissions.value })
            });
            closeAdminModal();
        };

        const selectSensor = async (id) => {
            selectedSensor.value = id;
            currentView.value = 'detail';
            await fetchSensorData(id);
            nextTick(() => {
                renderCharts();
                lucide.createIcons();
            });
        };

        const fetchSensorData = async (id) => {
            const res = await fetch(`/api/data/${id}`);
            sensorData.value = await res.json();
        };

        const renderCharts = () => {
            if (currentView.value !== 'detail') return;

            const ctxIds = ['tempChart', 'humChart', 'pressureChart', 'batteryChart', 'rainChart', 'solarChart'];
            const labels = sensorData.value.map(d => new Date(d.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })).reverse();
            const dataPoints = sensorData.value.slice().reverse(); // Show oldest to newest left to right? usually chart shows time axis ->

            const createLineChart = (id, label, data, color) => {
                const ctx = document.getElementById(id);
                if (!ctx) return;
                if (charts[id]) charts[id].destroy();

                charts[id] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '20',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }, // Minimal look
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { grid: { color: '#ffffff10' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            };

            createLineChart('tempChart', 'Temperatur (°C)', dataPoints.map(d => d.decoded.Temperature), '#00AEEF');
            createLineChart('humChart', 'Luftfeuchtigkeit (%)', dataPoints.map(d => d.decoded.Humidity), '#005696');
            createLineChart('pressureChart', 'Luftdruck (hPa)', dataPoints.map(d => d.decoded.Pressure), '#10b981');
            createLineChart('batteryChart', 'Batterie (V)', dataPoints.map(d => d.decoded.Battery), '#f59e0b');
            createLineChart('rainChart', 'Regen (mm)', dataPoints.map(d => d.decoded.Rain), '#06b6d4');
            createLineChart('solarChart', 'Einstrahlung (W/m²)', dataPoints.map(d => d.decoded.Irradiation), '#818cf8');
        };

        const formatDateTime = (iso) => {
            return new Date(iso).toLocaleString();
        };

        const exportSelectedSensors = () => {
            let url = '/api/export';
            if (selectedSensorIds.value.length > 0) {
                const params = selectedSensorIds.value.map(id => `sensor_ids=${encodeURIComponent(id)}`).join('&');
                url = `${url}?${params}`;
            }
            window.location.href = url;
        };

        const selectAllSensors = () => {
            selectedSensorIds.value = sensors.value.map(s => s.id);
        };

        const clearSensorSelection = () => {
            selectedSensorIds.value = [];
        };

        const avgTemp = computed(() => {
            const valid = sensors.value.filter(s => s.latest_values.Temperature !== undefined);
            if (valid.length === 0) return 0;
            const sum = valid.reduce((acc, s) => acc + s.latest_values.Temperature, 0);
            return (sum / valid.length).toFixed(1);
        });

        // LIFECYCLE
        onMounted(() => {
            lucide.createIcons();
            checkStatus();
            updateTimer = setInterval(fetchSensors, 5000);
        });

        watch(currentView, () => {
            nextTick(() => lucide.createIcons());
        });

        return {
            isLoggedIn, username, isAdmin, currentView, sensors, selectedSensor, sensorData,
            isConnected, loginForm, loginError, login, logout, selectSensor,
            viewTitle, viewSubtitle, avgTemp, allData, formatDateTime,
            // Export functionality
            selectedSensorIds, exportSelectedSensors, selectAllSensors, clearSensorSelection,
            // Admin exports
            userList, showAdminModal, selectedUser, tempPermissions, allAvailableSensors,
            fetchUsers, openPermissionsModal, closeAdminModal, toggleSensorPermission, savePermissions,
            // Create User exports
            showCreateUserModal, createUserForm, openCreateUserModal, closeCreateUserModal, createUser
        };
            }
        });
        app.mount('#app');
    </script>
</body>

</html>